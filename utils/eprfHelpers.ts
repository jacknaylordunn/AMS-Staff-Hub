import * as firestore from 'firebase/firestore';
import type { EPRFForm, EventLog, User as AppUser } from '../types';

export const getInitialFormState = (event: EventLog | null, user: AppUser | null): EPRFForm => {
  const now = new Date();
  const timeString = now.toTimeString().split(' ')[0].substring(0, 5);
  const fullName = user ? `${user.firstName} ${user.lastName}`.trim() : '';
  return {
    patientId: null,
    eventId: event?.id || null,
    eventName: event?.name || null,
    presentationType: 'Medical/Trauma',
    incidentNumber: '',
    incidentDate: now.toISOString().split('T')[0],
    incidentTime: timeString,
    timeOfCall: timeString,
    onSceneTime: timeString,
    atPatientTime: '',
    leftSceneTime: '',
    atDestinationTime: '',
    clearDestinationTime: '',
    incidentLocation: event?.location || '',
    patientName: '',
    patientAge: '',
    patientGender: 'Unknown',
    presentingComplaint: '',
    history: '',
    mechanismOfInjury: '',
    allergies: [],
    medications: [],
    pastMedicalHistory: '',
    lastOralIntake: '',
    painAssessment: { onset: '', provocation: '', quality: '', radiation: '', severity: 0, time: '' },
    airway: '',
    breathing: '',
    circulation: '',
    disability: { 
      avpu: 'Alert', 
      gcs: { eyes: 4, verbal: 5, motor: 6, total: 15 }, 
      pupils: '',
      bloodGlucoseLevel: '',
      fastTest: {
        face: 'Normal',
        arms: 'Normal',
        speech: 'Normal',
      },
    },
    exposure: '',
    airwayDetails: {
        status: 'Clear',
        adjuncts: [],
    },
    breathingDetails: {
        effort: 'Normal',
        sounds: ['Clear'],
        sides: ['Bilaterally'],
    },
    circulationDetails: {
        pulseQuality: 'Strong',
        skin: 'Normal',
    },
    vitals: [{ time: timeString, hr: '', rr: '', bp: '', spo2: '', temp: '', bg: '', painScore: '0', avpu: 'Alert', onOxygen: false }],
    secondarySurvey: '',
    injuries: [],
    impressions: [],
    medicationsAdministered: [],
    interventions: [],
    itemsUsed: [],
    disposal: '',
    disposition: 'Not Set',
    dispositionDetails: { destination: '', receivingClinician: '', referralDetails: '' },
    handoverDetails: '',
    refusalOfCare: { refusedTreatment: false, refusedTransport: false, risksExplained: false, capacityDemonstrated: false, details: '' },
    safeguarding: { concerns: [], details: '' },
    mentalCapacity: { assessment: [], outcome: 'Not Assessed', details: '' },
    welfareLog: [],
    attachments: [],
    patientSignatureUrl: '',
    clinicianSignatureUrl: '',
    signaturesNeedSync: false,
    crewMembers: user ? [{ uid: user.uid, name: fullName }] : [],
    createdAt: firestore.Timestamp.now(),
    createdBy: user ? { uid: user.uid, name: fullName } : { uid: '', name: '' },
    status: 'Draft',
    auditLog: [],
    containsRestrictedDrugs: false,
  }
};